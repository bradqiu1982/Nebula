
@{
    ViewBag.Title = "JoSchedule";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="row">
    <div class="col-lg-12">&nbsp;</div>
</div>

<div class="row">
    <div class="col-lg-12">&nbsp;</div>
</div>
<div class="row">
    <div class="col-lg-12">&nbsp;</div>
</div>

<div class="row">
    <div class="col-lg-12">&nbsp;</div>
</div>

<div class="row">
    <h2>JoSchedule</h2>
</div>

<script type="text/javascript" src="~/Scripts/lobi/jquery.ui.touch-punch.min.js"></script>
<script type="text/javascript" src="~/Scripts/lobi/moment.min.js"></script>
<script type="text/javascript" src="~/Scripts/lobi/daterangepicker.js"></script>
<script type="text/javascript" src="~/Scripts/lobi/fullcalendar.js"></script>
<link href="@Url.Content("~/Scripts/lobi/lobiadmin-with-plugins.css")" rel="stylesheet" type="text/css" />
<link href="@Url.Content("~/Scripts/lobi/font-awesome.min.css")" rel="stylesheet" type="text/css" />


<div class="row">
    <div class="col-lg-1"></div>
    <div class="col-lg-10">
        <div id="event-calendar">
            <div class="panel panel-light">
                <div class="panel-body">
                    <div id="calendar-demo"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-1"></div>
</div>

<!-- Modal -->
<div class="modal fade" id="addEventModal" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Add event</h4>
            </div>
            <div class="modal-body">
                <form action>
                    <div class="form-group">
                        <label class="control-label">Event style</label>
                        <div class="btn-group btn-group-justified btn-group-event-style" data-toggle="buttons">
                            <label class="btn btn-primary active">
                                <input type="radio" name="style" value="bg-primary" checked> <i class="fa fa-check"></i>
                            </label>
                            <label class="btn bg-success text-white">
                                <input type="radio" name="style" value="bg-success"> <i class="fa fa-check"></i>
                            </label>
                            <label class="btn bg-danger text-white">
                                <input type="radio" name="style" value="bg-danger"> <i class="fa fa-check"></i>
                            </label>
                            <label class="btn bg-info text-white">
                                <input type="radio" name="style" value="bg-info"> <i class="fa fa-check"></i>
                            </label>
                            <label class="btn bg-warning text-white">
                                <input type="radio" name="style" value="bg-warning"> <i class="fa fa-check"></i>
                            </label>
                            <label class="btn bg-gray text-white">
                                <input type="radio" name="style" value="bg-gray"> <i class="fa fa-check"></i>
                            </label>
                            <label class="btn bg-cyan text-white">
                                <input type="radio" name="style" value="bg-cyan"> <i class="fa fa-check"></i>
                            </label>
                            <label class="btn bg-purple text-white">
                                <input type="radio" name="style" value="bg-purple"> <i class="fa fa-check"></i>
                            </label>
                            <label class="btn bg-pink text-white">
                                <input type="radio" name="style" value="bg-pink"> <i class="fa fa-check"></i>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        @Html.DropDownList("title", (IEnumerable<SelectListItem>)ViewBag.titlelist, new { @id = "title", @class = "form-control" })
                        @*<label class="control-label">Event title</label>
                            <input type="text" class="form-control" name="title" placeholder="Event title" />*@
                    </div>

                    <div class="form-group">
                        <input type="text" name="date-period" class="form-control" />
                    </div>


                    <div class="form-group">
                        <label class="control-label">Event description</label>
                        <textarea rows="3" class="form-control" name="desc"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-add">Add event</button>
                <button type="button" class="btn btn-primary btn-danger">Remove event</button>
            </div>
        </div>
    </div>
</div>



<script type="text/javascript">

    $(window).on("load", function () {
        initPage();
    });

    function initPage() {
        moment().zone('-08:00');

        var $addEventModal = $('#addEventModal');
        $addEventModal.appendTo('body');
        $addEventModal.on('show.bs.modal', function () {
            $addEventModal.find('form')[0].reset();
        });
        $addEventModal.on('hide.bs.modal', function () {
            eventToUpdate = null;
        });

        //Initialize single date picker
        $addEventModal.find('[name=date-period]').daterangepicker({
            singleDatePicker: false
        },
            function (start, end) {
                startDate = start;
                endDate = end;
            }
        );
        var startDate, endDate, eventToUpdate;
        //Date range input
        var $input = $addEventModal.find('[name=date-period]');
        $input.daterangepicker({
            timePicker: true,
            timePickerIncrement: 10,
            format: 'YYYY-MM-DD'
            //                    format: 'MM/DD/YYYY h:mm A'
        });


        $addEventModal.find('[name=title]').click(function () {
            var $check = $(this);
            var stDate = $input.data('daterangepicker').startDate;

            //Initialize date range picker
            $input.daterangepicker({
                timePicker: true,
                timePickerIncrement: 10,
                format: 'YYYY-MM-DD'
                //                    format: 'MM/DD/YYYY h:mm A'
            });
            //window.console.log(eventToUpdate);
            //window.console.log(stDate.format('YYYY-MM-DD h:mm:ss a'));
            if (!eventToUpdate || !eventToUpdate.end) {
                $input.data('daterangepicker').setStartDate(stDate);
                var enDate = stDate.add(2, 'hours');
                //window.console.log(enDate.format('YYYY-MM-DD h:mm:ss a'));
                $input.data('daterangepicker').setEndDate(enDate);
            } else if (eventToUpdate) {
                $input.data('daterangepicker').setStartDate(eventToUpdate.start);
                if (eventToUpdate.end) {
                    $input.data('daterangepicker').setEndDate(eventToUpdate.end);
                }
            }
        });

        var CALENDAR = $('#calendar-demo');
        //Listen to #addEventModal "Add Event" button click and add new event
        $addEventModal.find('.btn-add').click(function () {
            var $body = $(this).closest('.modal-content');
            var style = $body.find('[name=style]:checked').val();
            var title = $body.find('[name=title]').val();
            var desc = $body.find('[name=desc]').val();

            var startDate = $input.data('daterangepicker').startDate;
            var endDate = $input.data('daterangepicker').endDate;
            //            window.console.log(eventToUpdate);
            if (!eventToUpdate) {

                var event = {
                    title: title,
                    className: [style, style.replace('bg', 'border') + '-dark'],
                    description: desc
                };

                event.start = startDate;
                event.end = endDate;

                var myevent = {
                    title: title,
                    className: [style, style.replace('bg', 'border') + '-dark'],
                    description: desc,
                    start: startDate.format('YYYY-MM-DD'),
                    end: endDate.format('YYYY-MM-DD')
                };
                //                    window.console.log(event.start.format('YYYY-MM-DD h:mm:ss a'));
                //                    window.console.log(event.end.format('YYYY-MM-DD h:mm:ss a'));
                $.ajax('/BRTrace/AddScheduleEvent', {
                    data: myevent,
                    method: 'POST',
                    cache: false
                }).done(function (res) {
                    if (res.success) {
                        event.id = res.id;
                        CALENDAR.fullCalendar('renderEvent', event, true);
                    } else {

                    }
                });

            } else {

                eventToUpdate.title = title;
                eventToUpdate.className = [style, style.replace('bg', 'border') + '-dark'];
                eventToUpdate.description = desc;
                eventToUpdate.start = startDate;
                eventToUpdate.end = endDate;

                CALENDAR.fullCalendar('updateEvent', eventToUpdate);

                var myevent = {
                    id: eventToUpdate.id,
                    title: title,
                    className: [style, style.replace('bg', 'border') + '-dark'],
                    description: desc,
                    start: startDate.format('YYYY-MM-DD'),
                    end: endDate.format('YYYY-MM-DD')
                };

                $.ajax('/BRTrace/UpdateScheduleEvent', {
                    data: myevent,
                    method: 'POST',
                    cache: false
                }).done(function (res) {
                    if (res.success) {

                    } else {

                    }
                });
            }

            $addEventModal.modal('hide');
        });

        $addEventModal.find('.btn-danger').click(function () {

            if (eventToUpdate) {

                var myevent = {
                    id: eventToUpdate.id
                }

                $.ajax('/BRTrace/RemoveScheduleEvent', {
                    data: myevent,
                    method: 'POST',
                    cache: false
                }).done(function (res) {
                    if (res.success) {
                        CALENDAR.fullCalendar('removeEvents', myevent.id);
                    } else {

                    }
                });
            }
            $addEventModal.modal('hide');
        });
        var myDate = new Date();
        var mydatestr = myDate.getUTCFullYear() + '-' + ("0" + (myDate.getUTCMonth() + 1)).slice(-2) + '-' + ("0" + myDate.getUTCDate()).slice(-2);

        CALENDAR.fullCalendar({
            dayClick: function (date, jsEvent, view) {
                $addEventModal.modal('show');
                //                window.console.log(date.format('YYYY-MM-DD h:mm:ss a'));
                $input.data('daterangepicker').setOptions({
                    singleDatePicker: true
                });
                $addEventModal.find('[name=title]')[0].selectedIndex = 0;
                $addEventModal.find('.btn-add').html('Add event');
                $addEventModal.find('.btn-danger').hide();
                $addEventModal.find('[name=date-period]').data('daterangepicker').setStartDate(date);
                $addEventModal.find('[name=date-period]').data('daterangepicker').setEndDate(date);
            },
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
            },
            defaultDate: mydatestr,
            editable: true,
            droppable: true,
            eventLimit: true,
            businessHours: true,
            buttons: false,
            eventRender: function (event, element, view) {
                if (event.description) {
                    element.append('<span class="fc-description">' + event.description + '</span>');
                }
            },
            eventClick: function (calEvent, jsEvent, view) {
                eventToUpdate = calEvent;
                $addEventModal.modal('show');
                $addEventModal.find('.btn-add').html('Update event');
                $addEventModal.find('.btn-danger').show();
                var className = calEvent.className;
                if (className && typeof className === 'string') {
                    $addEventModal.find('[name="style"][value="' + className + '"]').prop('checked', true);
                } else if (className && className.length > 0) {
                    for (var i = 0; i < className.length; i++) {
                        if (className[i].indexOf('bg') === 0) {
                            $addEventModal.find('[name="style"][value="' + className[i] + '"]').prop('checked', true);
                            break;
                        }
                    }
                }

                //Initialize date range picker
                $addEventModal.find('[name=date-period]').daterangepicker({
                    timePicker: true,
                    timePickerIncrement: 10,
                    format: 'YYYY-MM-DD'
                    //                            format: 'MM/DD/YYYY h:mm A',
                    //                            timeZone: '-08:00'
                },
                    function (start, end) {
                        startDate = start;
                        endDate = end;
                    }
                );

                if (!calEvent.end) {
                    calEvent.end = moment();
                }
                $addEventModal.find('[name=date-period]').data('daterangepicker').setStartDate(calEvent.start);
                $addEventModal.find('[name=date-period]').data('daterangepicker').setEndDate(calEvent.end);

                $addEventModal.find('[name=title]').val(calEvent.title);
                $addEventModal.find('[name=desc]').val(calEvent.description || '');
                CALENDAR.fullCalendar('updateEvent', calEvent);

                // change the border color just for fun
                $(this).css('border-color', 'red');

            },
            eventDrop: function (calEvent, jsEvent, view) {
                var myevent = {
                    id: calEvent.id,
                    start: calEvent.start.format('YYYY-MM-DD'),
                    end: calEvent.end.format('YYYY-MM-DD')
                };

                $.ajax('/BRTrace/MoveScheduleEvent', {
                    data: myevent,
                    method: 'POST',
                    cache: false
                });
            },
            eventResize: function (calEvent, jsEvent, view) {
                var myevent = {
                    id: calEvent.id,
                    start: calEvent.start.format('YYYY-MM-DD'),
                    end: calEvent.end.format('YYYY-MM-DD')
                };

                $.ajax('/BRTrace/MoveScheduleEvent', {
                    data: myevent,
                    method: 'POST',
                    cache: false
                });
            },
            events: {
                url: '/BRTrace/JOSchedules',
                type: 'POST',
                data: {
                    JoNum: 'jonum'
                },
                cache: false
            }

        });
    }
</script>


